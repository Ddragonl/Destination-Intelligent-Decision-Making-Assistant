# 使用说明

本文档包含项目的详细配置和使用步骤。

## 快速开始

### 第一步：安装依赖

```bash
pip install -r requirements.txt
```

### 第二步：获取高德地图API Key

需要配置**两个**API Key：

#### 1. 服务端API Key（用于后端查询）

1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册/登录账号
3. 进入"控制台" → "应用管理" → "我的应用" → "创建新应用"
4. 应用名称：`目的地决策智能体-服务端`
5. 应用类型：**Web服务**
6. 点击"添加"按钮添加Key
7. Key名称：`服务端Key`
8. 服务平台：**Web服务**
9. 提交后复制Key

#### 2. Web端API Key（用于前端地图显示）

1. 在同一控制台再次点击"创建新应用"
2. 应用名称：`目的地决策智能体-Web端`
3. 应用类型：**Web端(JS API)**
4. 点击"添加"按钮添加Key
5. Key名称：`Web端Key`
6. 服务平台：**Web端(JS API)**
7. 提交后复制Key

**注意**：如果提示需要配置安全密钥，这是Web端API的安全特性，建议配置以提高安全性。

### 第三步：配置API Key

#### 配置服务端Key（后端使用）

在项目根目录创建 `.env` 文件：

```env
AMAP_API_KEY=你的服务端API_Key
```

**注意**：
- 不要有引号
- 不要有空格
- 直接填写Key值

#### 配置Web端Key（前端使用）

编辑 `static/index.html` 文件，找到以下行（约第10行）：

```html
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=YOUR_AMAP_WEB_KEY"></script>
```

将 `YOUR_AMAP_WEB_KEY` 替换为你的Web端API Key。

### 第四步：启动服务

```bash
python start_server.py
```

看到以下信息表示启动成功：

```
🚀 启动目的地自主决策智能体Web服务...
📱 访问地址: http://localhost:8000
按 Ctrl+C 停止服务
```

### 第五步：使用Web界面

1. 打开浏览器访问：`http://localhost:8000`
2. 填写查询信息：
   - **我的位置**：例如"浙江大学紫金港校区"
   - **连锁店名称**：例如"联想电脑专卖店"
   - **所在城市**：例如"杭州"
   - **交通方式**：选择偏好的交通方式（可选，留空则自动选择最优）
3. 点击"开始查询"
4. 查看推荐结果和地图路线

## 使用方法

### 方式1：Web界面使用（推荐）⭐

启动服务器后，在浏览器中使用图形界面，支持实时地图显示。

**特点**：
- 直观的图形界面
- 实时地图显示路线
- 详细的路线指引
- 备选方案展示

### 方式2：命令行使用

```bash
python src/main.py "浙江大学紫金港校区" "联想电脑专卖店" "杭州" "transit"
```

**参数说明**：
- 第1个参数：用户位置（地址或坐标）
- 第2个参数：连锁店名称
- 第3个参数：城市名称（可选，默认"杭州"）
- 第4个参数：偏好交通方式（可选：transit/driving/walking/riding）

**示例**：
```bash
# 查询公共交通路线
python src/main.py "浙江大学紫金港校区" "联想电脑专卖店" "杭州" "transit"

# 查询驾车路线
python src/main.py "杭州市西湖区" "星巴克" "杭州" "driving"

# 自动选择最优方案
python src/main.py "浙江大学紫金港校区" "联想电脑专卖店" "杭州"
```

### 方式3：Python代码调用

```python
from src.mcp.mcp_client import MCPClient

client = MCPClient()
result = client.process_request(
    user_location_str="浙江大学紫金港校区",
    store_name="联想电脑专卖店",
    city="杭州",
    preferred_mode="transit"  # 可选
)

if result["success"]:
    rec = result["recommendation"]
    print(f"推荐目的地：{rec['destination']['name']}")
    print(f"地址：{rec['destination']['address']}")
    print(f"交通方式：{rec['route']['traffic_mode_cn']}")
    print(f"预计时间：{rec['route']['duration_formatted']}")
    print(f"距离：{rec['route']['distance_formatted']}")
else:
    print(f"查询失败：{result.get('error')}")
```

### 方式4：HTTP API调用

启动服务器后，可以通过HTTP API调用：

**Windows PowerShell**：
```powershell
curl -X POST "http://localhost:8000/api/query" `
  -H "Content-Type: application/json" `
  -d '{\"user_location\": \"浙江大学紫金港校区\", \"store_name\": \"联想电脑专卖店\", \"city\": \"杭州\", \"preferred_mode\": \"transit\"}'
```

**Linux/Mac**：
```bash
curl -X POST "http://localhost:8000/api/query" \
  -H "Content-Type: application/json" \
  -d '{
    "user_location": "浙江大学紫金港校区",
    "store_name": "联想电脑专卖店",
    "city": "杭州",
    "preferred_mode": "transit"
  }'
```

**Python requests**：
```python
import requests

response = requests.post(
    "http://localhost:8000/api/query",
    json={
        "user_location": "浙江大学紫金港校区",
        "store_name": "联想电脑专卖店",
        "city": "杭州",
        "preferred_mode": "transit"
    }
)
print(response.json())
```

## Web界面使用说明

### 界面功能

- **左侧面板**：
  - 查询表单：输入位置、门店、城市、交通方式
  - 推荐结果：显示最优推荐和详细路线
  - 备选方案：显示其他可选方案

- **右侧地图**：
  - 实时地图显示
  - 起点标记（蓝色）
  - 终点标记（红色）
  - 完整路线绘制（根据交通方式）

### 使用步骤

1. 启动服务器：`python start_server.py`
2. 打开浏览器：访问 `http://localhost:8000`
3. 填写表单：输入查询信息
4. 点击查询：查看结果和地图
5. 查看详情：路线步骤、备选方案等

### 路线显示说明

- **公共交通**：显示完整的公交/地铁换乘路线
- **驾车**：显示驾车路线
- **步行**：显示步行路线
- **骑行**：显示骑行路线
- **其他**：如果路线规划失败，会显示直线连接

## 常见问题

### 1. 提示"请配置高德地图API Key"

**解决**：
- 检查 `.env` 文件是否存在
- 检查 `.env` 文件中的 `AMAP_API_KEY` 是否正确填写
- 确保没有多余的空格或引号
- 检查文件编码是否为UTF-8

### 2. 地图不显示

**解决**：
- 检查 `static/index.html` 中的 `YOUR_AMAP_WEB_KEY` 是否已替换
- 检查网络连接是否正常
- 检查浏览器控制台是否有错误信息
- 验证Web端API Key是否有效
- 检查是否配置了安全密钥（如果API要求）

### 3. 查询失败

**解决**：
- 检查服务端API Key是否正确
- 检查网络连接
- 查看终端错误信息
- 检查API调用次数是否超限
- 确认API服务是否已开通（地理编码、地点搜索、路径规划）

### 4. 路线不显示

**解决**：
- 检查Web端API Key是否正确
- 尝试其他交通方式
- 检查浏览器控制台错误
- 某些区域可能没有对应交通方式的路线
- 检查起点和终点是否在同一个城市

### 5. 找不到门店

**解决**：
- 尝试使用更精确的店名（如"联想3C服务中心"）
- 检查城市名称是否正确
- 某些门店可能不在POI数据库中
- 尝试使用门店的完整名称

### 6. 路线查询失败

**解决**：
- 检查起点和终点是否在同一个城市
- 某些偏远地区可能没有公共交通路线
- 可以尝试其他交通方式（如驾车）
- 检查起点和终点的地址是否准确

### 7. API调用超限

**解决**：
- 高德地图免费版有每日调用限制
- 可以升级到付费版获得更高配额
- 合理使用，避免频繁调用
- 考虑添加缓存机制

### 8. 安全密钥相关问题

**解决**：
- 安全密钥是Web端API的可选安全特性
- 如果配置了安全密钥，需要在API调用时使用
- 前端JavaScript会自动处理安全密钥
- 如果不使用安全密钥，可以不配置

## 测试命令

### 测试后端API

```bash
python src/main.py "浙江大学紫金港校区" "联想电脑专卖店" "杭州" "transit"
```

### 测试Web API

**Windows PowerShell**：
```powershell
curl -X POST "http://localhost:8000/api/query" `
  -H "Content-Type: application/json" `
  -d '{\"user_location\": \"浙江大学紫金港校区\", \"store_name\": \"联想电脑专卖店\", \"city\": \"杭州\", \"preferred_mode\": \"transit\"}'
```

**Linux/Mac**：
```bash
curl -X POST "http://localhost:8000/api/query" \
  -H "Content-Type: application/json" \
  -d '{
    "user_location": "浙江大学紫金港校区",
    "store_name": "联想电脑专卖店",
    "city": "杭州",
    "preferred_mode": "transit"
  }'
```

### 测试健康检查

```bash
curl http://localhost:8000/api/health
```

## 技术支持

如遇问题，请检查：

1. **Python版本**：推荐使用Python 3.8或更高版本
   ```bash
   python --version
   ```

2. **依赖是否完整安装**
   ```bash
   pip list | grep -E "fastapi|uvicorn|requests|pydantic"
   ```

3. **API Key是否有效**
   - 登录高德开放平台控制台
   - 检查Key状态是否正常
   - 检查服务是否已开通

4. **网络连接是否正常**
   - 确保可以访问高德地图API服务器
   - 检查防火墙设置

5. **查看错误信息**
   - 终端错误日志
   - 浏览器控制台错误
   - 服务器日志

## 进阶配置

### 修改服务器端口

编辑 `start_server.py`，修改端口号：

```python
uvicorn.run(
    "src.api:app",
    host="0.0.0.0",
    port=8000,  # 修改这里
    ...
)
```

### 修改推荐算法

编辑 `src/services/decision_service.py`，调整推荐逻辑：

```python
# 修改权重和优先级
if preferred_route.duration <= best_route.duration * 1.2:  # 调整这个系数
    best_route = preferred_route
```

### 添加缓存机制

可以在 `src/services/map_service.py` 中添加缓存，减少API调用：

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_route_cached(self, origin_str, dest_str, mode):
    # 缓存路线查询结果
    ...
```

## 部署建议

### 开发环境
- 使用 `start_server.py` 启动，支持热重载
- 使用 `.env` 文件管理配置

### 生产环境
- 使用 `uvicorn` 直接启动，配置生产级参数
- 使用环境变量或配置管理工具
- 配置反向代理（如Nginx）
- 启用HTTPS
- 配置日志和监控

